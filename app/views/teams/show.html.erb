<script src="//maps.google.com/maps/api/js?key=AIzaSyATRUzirFftJGK94gjB8HUN3MuHLu4QgAw
"></script>
<script src="//cdn.rawgit.com/mahnunchik/markerclustererplus/master/dist/markerclusterer.min.js"></script>
<script src='//cdn.rawgit.com/printercu/google-maps-utility-library-v3-read-only/master/infobox/src/infobox_packed.js' type='text/javascript'></script> <!-- only if you need custom infoboxes -->
<% myLevel = -1 %>
<% @myLevel.each do |level|  %>
<%myLevel = level.level %>
<%end%>
<div class="container-fluid" id="teamsFree">
	<% if myLevel >= 0%>
	<div class="">
		<div class="row col-md-12">
			<h1 class="text-center">
				<strong><%= @team.name %></strong>
			</h1>
		</div>
		<div class="col-md-2 col-md-offset-5">
			<% if @team.logo.present? == true %>
			
				<%= image_tag( @team.logo_url, class:"img-responsive img-circle") %>
			<%else%>
				<%= image_tag("team.jpg", class:"img-responsive img-rounded")%>
			<% end %>
		</div>
		<div class="col-md-12 col-md-offset">
			<h3> <%= @team.description%> </h3>
		</div>	
		<div class="row">
		</div>
		<br>
		<br>
		<div class="">
			<div class="row" id="btn-dates">
				<div class="col-md-8">
					<div class="panel panel-primary">
						<div class="panel panel-heading">
							<h4 class="text-center">Notificaciones y mensajes</h4>
						</div>
						<div class="panel panel-body" style=" max-height: 450px; max-width:1; overflow-y: scroll;">

								<div class="row">
									<%if myLevel > 0%>
									<div class="">
										<%i = 0%>
										<% @teamMessages.each do |m| %>
											<% if i % 2 == 0 %>
												<div class="col-md-8">
													<div class="well well-sm">
														<h4 class="text-primary text-center text-uppercase"><%= m.title%></h4>				
														<%if m.type_message == 1%>
															<h5 class="text-justify text-success"><%= m.body%></h5>
														<%elsif m.type_message == 2%>
															<%m.document.each do |document|%>
															<p><%=link_to document.to_s.split('/')[5], document.to_s, :target => "_blank", class:"btn-xs btn" %></p>
															<%end%>
														<%elsif m.type_message == 3%>
															<div style='width: 500px;'>
 																 <div id="viewMap" style='width: 500px; height: 400px;'></div>
															</div>

														<%end%>
														<p class="text-muted small">Mensaje de: <%= User.includes(:members).where(members:{id: m.member_id}).pluck(:email)[0]%></p>
															
													</div>
												</div>
											<%else%>
												<div class="col-md-8 col-md-offset-4">
													<div class="well well-sm text-right">
													<h4 class="text-primary text-center text-uppercase"><%= m.title%></h4>
													<%=m.type_message %>
													<%if m.type_message == 1%>
														<h5 class="text-justify text-success"><%= m.body%></h5>
													<%elsif m.type_message == 2%>
														<%m.document.each do |document|%>
															<p><%=link_to document.to_s.split('/')[5], document.to_s, :target => "_blank", class:"btn-xs btn" %></p>
															<%end%>
													<%elsif m.type_message == 3%>
															<div style='width: 500px;'>
 																 <div id="viewMap" style='width: 500px; height: 400px;'></div>
															</div>
													<%end%>
													<p class="text-muted small">Mensaje de: <%= User.includes(:members).where(members:{id: m.member_id}).pluck(:email)[0]%></p>
													</div>
												</div>
											<% end %>
											<% i = i +1 %>
										<% end %></div>
										<%end%>
								</div>

							<%if myLevel > 0%>
							</div>
							<div class="btn-group btn-group-justified">
								<a href="#texto"  class="btn btn-wall" data-toggle="modal">Enviar mensaje</a>
								<a href="#documento" class="btn btn-wall" data-toggle="modal">Enviar documento(s)</a>
								<a href="#reunion" class="btn btn-wall" data-toggle="modal">Programar reunion</a>

							</div>
							<%end%>
						
					</div>
				</div>
				<div class="col-md-4">
					<div class="row">
						<div class="col-md-12">
							<div class="panel-group">
								<div class="panel panel-info">
									<div class="panel-heading">
										<h5 class="text-center">
											<a data-toggle="collapse" href="#integrantes">
												Integrantes <span class="badge"><%= @numberOfMemberIn[@team.id]%></span>
											</a>
										</h5>
									</div>
									<div class="panel-collapse collapse" id="integrantes">
										<div class="panel-body">
											<%if myLevel < 2%>
											<div class="list-group">
												<% @userMembers.each do |u| %>
												<li class="list-group-item list-group-item-info">
													<%= u.email %>	
												</li>
												<%end%>
											</div>
											<%else%>
												<div class="btn-group-vertical btn-block">
													<% @userMembers.each do |u| %>
														<div class="dropdown">
															<button class="btn btn-info dropdown-toggle btn-block" type="button" data-toggle="dropdown">
																<%= u.email %>
																<span class="caret"></span>
															</button>
															<%@memberIn.each do |m|%>
															<%if m.user_id == u.id%>
															<% if myLevel > m.level%>
															<ul class="dropdown-menu dropdown-menu-left">
																
																	<li>
																		<%= button_to 'Eliminar del grupo', member_path(m), method: :delete, data: { confirm: '¿Esta seguro de eliminar '+ u.email + ' ?' }, class: "btn btn-block btn-danger "%>
																	</li>
																<li class="dropdown-submenu dropdown-menu-right">
																	<a href="" class="test btn btn-block btn-warning"> Cambia el nivel <span class="caret"></a>
																		<ul class="dropdown-menu">
																			<% for x in (1..myLevel-1)%>
																				<li>
																					<% if x != m.level %>
																						<% case x %>
																							<%when 1 %>
																								<%= button_to 'Usuario',member_path( :id => m.id, 'member[level]' => 1), method: :put, class: "btn btn-block btn-info"%>
																							<%when 2 %>
																								<%= button_to 'Monitor',member_path( :id => m.id, 'member[level]' => 2), method: :put, class: "btn btn-block btn-primary 	"%>
																							<%when 3 %>
																								<%= button_to 'Propietario',member_path( :id => m.id, 'member[level]' => 3), method: :put, class: "btn btn-block btn-warning"%>
																							<%end%>
																					<%end%>
																				</li>
																			<%end%>
																		</ul>
																</li>
															</ul>
															<%end%>
															<%end%>
														<%end%>
														</div>
													<%end%>
												</div>
											<%end%>
										</div>
									</div>
								</div>
							</div>
						</div>
						<%if  myLevel  > 1  && @numberOfMemberIn[@team.id] <= @team.max_member %>
						<div class="col-md-12">
							<div class="panel-group">
								<div class="panel panel-success">
									<div class="panel-heading">
										<h5 class="text-center ">
											<a data-toggle="collapse" href="#invitacionesPendientes" >Invitaciones pendientes  <span class="badge"> <%= @numberOfMember[@team.id] -@numberOfMemberIn[@team.id] %></span></a>
										</h5>
									</div>
									<div id="invitacionesPendientes" class="panel-collapse collapse">
										<div class="panel-body">
											<div class="btn-group-vertical btn-block">
												<%@userInscription.each do |i| %>
												<div class="dropdown">
													<button class="btn btn-success dropdown-toggle btn-block" type="button" data-toggle="dropdown">
														<%= i.email%>
														<span class="caret"></span>
													</button>
													<% @memberInscription.each do |member| %>
													<%if  member.user_id == i.id%>
													<ul class="dropdown-menu dropdown-menu-right">
														<li>

															<%= button_to 'Por supuesto', member_path( :id => member.id, 'member[level]' => 1), method: :put, class: "btn btn-block btn-primary"%>
														</li>
														<li>
															<%= button_to 'No gracias', member_path(member), method: :delete, data: { confirm: '¿Esta seguro de eliminar '+ i.email + ' ?' },  class: "btn btn-block btn-sucess "%>
														</li>
													</ul>
													<% end %>
													<% end %>
												</div>
												<% end %>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
						<% end %>
					</div>
				</div>
			</div>
		</div>
	</div>
	<%else%>
	<h2 class="text-center">No tienes acceso a este grupo</h2>
	<%end%>
</div>
<% if myLevel > 1%>

<div class="text-right" id="link"> 
	<div class="container"><%= link_to 'Editar..', edit_team_path(@team), class:"btn btn-link btn-lg" %> </div>
</div>
<% end %>




<div class="modal fade" id="reunion" role="">
	<div class="modal-dialog">

		<!-- Modal content-->
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="">&times;</button>
				<h4 class="modal-title text-center">Programa una reunion para hacerla publica al grupo</h4>
			</div>
			<div class="modal-body">
				<div class="container" >
					<div class="row col-md-4"><%=render "messages/form_meeting",  message: @message%></div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
			</div>
		</div>

	</div>
</div>
<div class="modal fade" id="texto" role="">
	<div class="modal-dialog">

		<!-- Modal content-->
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="">&times;</button>
				<h4 class="modal-title text-center">Ingresa un mensaje para el grupo</h4>
			</div>
			<div class="modal-body">
				<div class="container">
					<div class="row col-md-4"><%=render "messages/form_text",  message: @message%></div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-danger btn-sm" data-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="documento" role="">
	<div class="modal-dialog">

		<!-- Modal content-->
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="">&times;</button>
				<h4 class="modal-title text-center">Ingresa archivos para compartir en el grupo</h4>
			</div>
			<div class="modal-body">
				<div class="container">
					<div class="row col-md-6"><%=render "messages/form_document",  message: @message%></div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-danger btn-sm" data-dismiss="modal">Close</button>
			</div>
		</div>

	</div>
</div>





<script>

$("#reunion").on("shown.bs.modal", function () {
    google.maps.event.trigger(mapModal, "resize");
});

$(document).ready(function(){
  $('.dropdown-submenu a.test').on("click", function(e){
    $(this).next('ul').toggle();
    e.stopPropagation();
    e.preventDefault();
  });
});


</script>

<script>
	handler = Gmaps.build('Google');
	handler.buildMap({ provider: {}, internal: {id: 'viewMap'}}, function(){
 	markers = handler.addMarkers(<%=raw @hash.to_json %>);
  	handler.bounds.extendWith(markers);
  	handler.fitMapToBounds();
});
</script>