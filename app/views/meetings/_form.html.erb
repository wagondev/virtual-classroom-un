<script src="//maps.google.com/maps/api/js?key=AIzaSyATRUzirFftJGK94gjB8HUN3MuHLu4QgAw"></script>
<script src="//cdn.rawgit.com/mahnunchik/markerclustererplus/master/dist/markerclusterer.min.js"></script>
<script src='//cdn.rawgit.com/printercu/google-maps-utility-library-v3-read-only/master/infobox/src/infobox_packed.js' type='text/javascript'></script> <!-- only if you need custom infoboxes -->
<%= form_with(model: meeting, local: true) do |form| %>
  <% if meeting.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(meeting.errors.count, "error") %> prohibited this meeting from being saved:</h2>

      <ul>
      <% meeting.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <div class="field" id="latitude">
    <%= form.label :latitude %>
    <%= form.text_field :latitude, id: :meeting_latitude %>
  </div>

  <div class="field" id="longitude">
    <%= form.label :longitude %>
    <%= form.text_field :longitude, id: :meeting_longitude %>
  </div>

  <div class="field" id="address">
    <%= form.label :address %>
    <%= form.text_field :address, id: :meeting_address %>
  </div>

  <div class="field">
    <%= form.label :decription %>
    <%= form.text_area :decription, id: :meeting_decription %>
  </div>

  <div class="field" id="name">
    <%= form.label :title %>
    <%= form.text_field :title, id: :meeting_title %>
  </div>

  <div class="field">
    <%= form.label :time %>
    <%= (form.datetime_select :time, id: :meeting_time) %>

  </div>

  <div class="actions">
    <%= form.submit %>
  </div>
<% end %>

<div>
  <div class ="map2" id="map" ></div>
</div>


<script type="text/javascript">
  var markers = [];
  handler = Gmaps.build('Google');
  handler.buildMap({ 
    provider: {
      zoom: 14,
      center: new google.maps.LatLng(4.635540,-74.082807),
    }, 
    internal: {
      id: 'map'
    }});
  
  google.maps.event.addListener(handler.getMap(), 'click', function(event) {
    placeMarker(event.latLng);
    dir(event.latLng);
  })
  
  function dir (latlng){
    var geocoder = new google.maps.Geocoder();
    var infowindow = new google.maps.InfoWindow;
    geocoder.geocode({'meeting_location': latlng}, function(results, status) {
      if (status === 'OK') {
        if (results[1]) {
          handler.getMap().setZoom(11);
          var marker = new google.maps.Marker({
            icon: 'info-i_maps.png',
            position: latlng,
            map: handler.getMap()
          });
          document.getElementById("meeting_address").value = results[1].formatted_address;
          infowindow.setContent(results[1].formatted_address);
          infowindow.open(map, marker);
        } else {
          window.alert('No results found');
        }
      } else {
        window.alert('Geocoder failed due to: ' + status);
      }
    });
  }
  
  function placeMarker(location) {
    var marker = new google.maps.Marker({
        position: location, 
        map: handler.getMap(),
        draggable: true
    });
    document.getElementById('meeting_latitude').value = location;
    var aux = document.getElementById('meeting_latitude').value.substr(1,document.getElementById('meeting_latitude').value.length - 2).split(",")
    document.getElementById("meeting_latitude").value = aux[0]
    document.getElementById("meeting_longitude").value = aux[1]
    google.maps.event.addListener(marker, 'click', function(event) {
      marker.setMap(null);
    });
  }
    
</script>